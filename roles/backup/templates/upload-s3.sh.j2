#!/bin/bash
set -euo pipefail

# Load configuration
source "{{ app_base_path }}/backup.conf"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [S3] $1"
}

send_telegram() {
    local message="$1"
    if [[ "$TELEGRAM_ENABLED" == "true" ]]; then
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${message}" \
            -d "parse_mode=HTML" > /dev/null 2>&1 || true
    fi
}

# Find latest backup
LATEST_BACKUP=$(ls -1t "${LOCAL_BACKUP_PATH}/${APP_NAME}_"*.tar.gz 2>/dev/null | head -1)

if [[ -z "$LATEST_BACKUP" ]]; then
    log "ERROR: No backup files found"
    send_telegram "❌ <b>S3 Upload Failed: ${APP_NAME}</b>%0AError: No backup files found"
    exit 1
fi

BACKUP_NAME=$(basename "$LATEST_BACKUP")
ENCRYPTED_FILE="${LATEST_BACKUP}.gpg"

log "Starting S3 upload for ${BACKUP_NAME}"

# Encrypt backup
log "Encrypting backup..."
gpg --batch --yes --symmetric --cipher-algo AES256 \
    --passphrase-file "$GPG_KEY_PATH" \
    --output "$ENCRYPTED_FILE" \
    "$LATEST_BACKUP"

# Upload to S3
log "Uploading to S3..."
REMOTE_PATH="s3:${CLOUD_S3_BUCKET}/${CLOUD_S3_PREFIX}"

if rclone --config="$RCLONE_CONFIG" copy "$ENCRYPTED_FILE" "$REMOTE_PATH" --progress; then
    log "Upload successful"

    # Cleanup encrypted file
    rm -f "$ENCRYPTED_FILE"

    # Apply retention policy
    log "Applying retention policy (${CLOUD_S3_RETENTION_DAYS} days)..."
    CUTOFF_DATE=$(date -d "-${CLOUD_S3_RETENTION_DAYS} days" +%Y%m%d)

    rclone --config="$RCLONE_CONFIG" lsf "${REMOTE_PATH}" | grep "^${APP_NAME}_" | while read -r file; do
        FILE_DATE=$(echo "$file" | grep -oP '\d{8}' | head -1)
        if [[ -n "$FILE_DATE" && "$FILE_DATE" < "$CUTOFF_DATE" ]]; then
            log "Deleting old backup: $file"
            rclone --config="$RCLONE_CONFIG" delete "${REMOTE_PATH}/${file}"
        fi
    done

    log "S3 upload complete"
    echo "success"
else
    log "ERROR: Upload failed"
    rm -f "$ENCRYPTED_FILE"
    send_telegram "❌ <b>S3 Upload Failed: ${APP_NAME}</b>%0AFile: ${BACKUP_NAME}"
    exit 1
fi
