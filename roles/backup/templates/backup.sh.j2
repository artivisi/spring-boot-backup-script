#!/bin/bash
set -euo pipefail

# Load configuration
source "{{ app_base_path }}/backup.conf"

# Timestamp
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="${APP_NAME}_${TIMESTAMP}"
TEMP_DIR=$(mktemp -d)
BACKUP_FILE="${LOCAL_BACKUP_PATH}/${BACKUP_NAME}.tar.gz"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

send_telegram() {
    local message="$1"
    if [[ "$TELEGRAM_ENABLED" == "true" ]]; then
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${message}" \
            -d "parse_mode=HTML" > /dev/null 2>&1 || true
    fi
}

cleanup() {
    rm -rf "$TEMP_DIR"
}
trap cleanup EXIT

log "Starting backup for ${APP_NAME}"

# Initialize manifest
MANIFEST_FILE="${TEMP_DIR}/manifest.json"
echo "{" > "$MANIFEST_FILE"
echo "  \"app_name\": \"${APP_NAME}\"," >> "$MANIFEST_FILE"
echo "  \"timestamp\": \"${TIMESTAMP}\"," >> "$MANIFEST_FILE"
echo "  \"created_at\": \"$(date -Iseconds)\"," >> "$MANIFEST_FILE"
echo "  \"checksums\": {" >> "$MANIFEST_FILE"

FIRST_CHECKSUM=true

add_checksum() {
    local name="$1"
    local file="$2"
    local checksum=$(sha256sum "$file" | cut -d' ' -f1)
    if [[ "$FIRST_CHECKSUM" == "true" ]]; then
        FIRST_CHECKSUM=false
    else
        echo "," >> "$MANIFEST_FILE"
    fi
    echo -n "    \"${name}\": \"${checksum}\"" >> "$MANIFEST_FILE"
}

# Database backup
log "Backing up database..."
DB_DUMP_FILE="${TEMP_DIR}/database.sql"

if [[ "$DB_TYPE" == "postgres" ]]; then
    export PGPASSFILE="{{ app_base_path }}/.pgpass"
    pg_dump -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -f "$DB_DUMP_FILE"
elif [[ "$DB_TYPE" == "mariadb" ]]; then
    mysqldump --defaults-file="{{ app_base_path }}/.my.cnf" "$DB_NAME" > "$DB_DUMP_FILE"
else
    log "ERROR: Unknown database type: $DB_TYPE"
    send_telegram "❌ <b>Backup Failed: ${APP_NAME}</b>%0AError: Unknown database type: ${DB_TYPE}"
    exit 1
fi

add_checksum "database.sql" "$DB_DUMP_FILE"
log "Database backup complete"

# Documents backup
if [[ "$BACKUP_DOCUMENTS" == "true" ]]; then
    if [[ -d "$BACKUP_DOCUMENTS_PATH" ]]; then
        log "Backing up documents..."
        DOCS_TAR="${TEMP_DIR}/documents.tar.gz"
        tar -czf "$DOCS_TAR" -C "$(dirname "$BACKUP_DOCUMENTS_PATH")" "$(basename "$BACKUP_DOCUMENTS_PATH")"
        add_checksum "documents.tar.gz" "$DOCS_TAR"
        log "Documents backup complete"
    else
        log "WARNING: Documents path does not exist: $BACKUP_DOCUMENTS_PATH"
    fi
fi

# JAR backup
if [[ "$BACKUP_JAR" == "true" ]]; then
    if [[ -f "$BACKUP_JAR_PATH" ]]; then
        log "Backing up JAR file..."
        cp "$BACKUP_JAR_PATH" "${TEMP_DIR}/app.jar"
        add_checksum "app.jar" "${TEMP_DIR}/app.jar"
        log "JAR backup complete"
    else
        log "ERROR: JAR file does not exist: $BACKUP_JAR_PATH"
        send_telegram "❌ <b>Backup Failed: ${APP_NAME}</b>%0AError: JAR file not found: ${BACKUP_JAR_PATH}"
        exit 1
    fi
fi

# Nginx config backup
if [[ "$BACKUP_NGINX" == "true" ]]; then
    if [[ -f "$BACKUP_NGINX_PATH" ]]; then
        log "Backing up nginx config..."
        cp "$BACKUP_NGINX_PATH" "${TEMP_DIR}/nginx.conf"
        add_checksum "nginx.conf" "${TEMP_DIR}/nginx.conf"
        log "Nginx config backup complete"
    else
        log "WARNING: Nginx config does not exist: $BACKUP_NGINX_PATH"
    fi
fi

# Systemd service backup
if [[ "$BACKUP_SYSTEMD" == "true" ]]; then
    if [[ -f "$BACKUP_SYSTEMD_PATH" ]]; then
        log "Backing up systemd service..."
        cp "$BACKUP_SYSTEMD_PATH" "${TEMP_DIR}/systemd.service"
        add_checksum "systemd.service" "${TEMP_DIR}/systemd.service"
        log "Systemd service backup complete"
    else
        log "WARNING: Systemd service does not exist: $BACKUP_SYSTEMD_PATH"
    fi
fi

# Close manifest JSON
echo "" >> "$MANIFEST_FILE"
echo "  }," >> "$MANIFEST_FILE"
echo "  \"backup_scope\": {" >> "$MANIFEST_FILE"
echo "    \"documents\": ${BACKUP_DOCUMENTS}," >> "$MANIFEST_FILE"
echo "    \"jar\": ${BACKUP_JAR}," >> "$MANIFEST_FILE"
echo "    \"nginx\": ${BACKUP_NGINX}," >> "$MANIFEST_FILE"
echo "    \"systemd\": ${BACKUP_SYSTEMD}" >> "$MANIFEST_FILE"
echo "  }" >> "$MANIFEST_FILE"
echo "}" >> "$MANIFEST_FILE"

# Create final archive
log "Creating backup archive..."
tar -czf "$BACKUP_FILE" -C "$TEMP_DIR" .
BACKUP_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
log "Backup archive created: $BACKUP_FILE ($BACKUP_SIZE)"

# Local rotation
log "Rotating local backups..."
BACKUP_COUNT=$(ls -1 "${LOCAL_BACKUP_PATH}/${APP_NAME}_"*.tar.gz 2>/dev/null | wc -l)
if [[ $BACKUP_COUNT -gt $LOCAL_RETENTION_COUNT ]]; then
    DELETE_COUNT=$((BACKUP_COUNT - LOCAL_RETENTION_COUNT))
    ls -1t "${LOCAL_BACKUP_PATH}/${APP_NAME}_"*.tar.gz | tail -n "$DELETE_COUNT" | xargs rm -f
    log "Deleted $DELETE_COUNT old backup(s)"
fi

log "Backup completed successfully"

# Send success notification
send_telegram "✅ <b>Backup Success: ${APP_NAME}</b>%0ASize: ${BACKUP_SIZE}%0AFile: ${BACKUP_NAME}.tar.gz"
