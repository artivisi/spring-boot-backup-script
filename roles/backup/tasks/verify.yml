---
- name: Verify backup script exists
  stat:
    path: "{{ app_base_path }}/scripts/backup.sh"
  register: backup_script

- name: Fail if backup script missing
  fail:
    msg: "Backup script not found at {{ app_base_path }}/scripts/backup.sh"
  when: not backup_script.stat.exists

- name: Verify database connectivity
  shell: |
    {% if db_type == 'postgres' %}
    PGPASSFILE="{{ app_base_path }}/.pgpass" psql -h {{ db_host }} -p {{ db_port }} -U {{ db_user }} -d {{ db_name }} -c "SELECT 1"
    {% else %}
    mysql --defaults-file="{{ app_base_path }}/.my.cnf" {{ db_name }} -e "SELECT 1"
    {% endif %}
  changed_when: false
  register: db_check

- name: Show database connectivity result
  debug:
    msg: "Database connection successful"
  when: db_check.rc == 0
