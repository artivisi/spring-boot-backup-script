---
- name: Check if rclone is available
  command: which rclone
  register: rclone_check
  changed_when: false
  failed_when: false

- name: Fail if rclone not installed
  fail:
    msg: "rclone not found. Please install rclone manually."
  when: rclone_check.rc != 0

- name: Deploy rclone config for B2
  template:
    src: rclone-b2.conf.j2
    dest: "{{ app_base_path }}/.config/rclone/rclone.conf"
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0600'
  when: not cloud_gdrive_enabled and not cloud_s3_enabled

- name: Add B2 config to rclone.conf
  blockinfile:
    path: "{{ app_base_path }}/.config/rclone/rclone.conf"
    marker: "# {mark} B2 CONFIG"
    block: |
      [b2]
      type = b2
      account = {{ vault_b2_account_id }}
      key = {{ vault_b2_app_key }}
    create: true
    mode: '0600'

- name: Fix rclone config ownership
  file:
    path: "{{ app_base_path }}/.config/rclone/rclone.conf"
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0600'

- name: Deploy B2 upload script
  template:
    src: upload-b2.sh.j2
    dest: "{{ app_base_path }}/scripts/upload-b2.sh"
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0700'

- name: Deploy cloud sync script
  template:
    src: cloud-sync.sh.j2
    dest: "{{ app_base_path }}/scripts/cloud-sync.sh"
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0700'

- name: Test B2 connectivity
  command: >
    rclone --config="{{ app_base_path }}/.config/rclone/rclone.conf"
    lsd "b2:{{ cloud_b2_bucket }}"
  changed_when: false
  register: b2_test
  failed_when: false

- name: Show B2 connectivity result
  debug:
    msg: "B2 connectivity test {{ 'passed' if b2_test.rc == 0 else 'failed: ' + b2_test.stderr }}"
